From a8cff5266dc590af0e6f2276f1c17f5ff3cdbd4e Mon Sep 17 00:00:00 2001
From: 4m8 <4m@I.oN>
Date: Wed, 6 Jan 2016 16:19:28 +0100
Subject: fix stagefright vulnerability

Change-Id: I3490735ad9ceaf8c6aae2d57547dff73795d3713
---
 libs/utils/String8.cpp | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/libs/utils/String8.cpp b/libs/utils/String8.cpp
index 562f026..2fc1913 100644
--- a/libs/utils/String8.cpp
+++ b/libs/utils/String8.cpp
@@ -14,6 +14,9 @@
  * limitations under the License.
  */
 
+#define __STDC_LIMIT_MACROS
+#include <stdint.h>
+
 #include <utils/String8.h>
 
 #include <utils/Log.h>
@@ -79,6 +82,11 @@ void terminate_string8()
 static char* allocFromUTF8(const char* in, size_t len)
 {
     if (len > 0) {
+
+        if (len == SIZE_MAX) {
+            return NULL;
+        }
+
         SharedBuffer* buf = SharedBuffer::alloc(len+1);
         ALOG_ASSERT(buf, "Unable to allocate shared buffer");
         if (buf) {
-- 
2.5.0

